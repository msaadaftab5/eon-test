AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'test

  Sample SAM Template for test

  '
Resources:
  AWSWranglerLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: aws-wrangler-layer
      Description: AWS Wrangler layer from GitHub
      ContentUri: ../../awswrangler-layer-3.9.0-py3.11.zip
      CompatibleRuntimes:
      - python3.9
  BronzeTransformationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BronzeTransformationFunction
      Handler: bronze_transformer.lambda_handler
      Runtime: python3.9
      Architectures:
      - x86_64
      Timeout: 900
      MemorySize: 1024
      Layers:
      - Ref: AWSWranglerLayer
      LoggingConfig:
        LogFormat: JSON
    Metadata:
      SamResourceId: BronzeTransformationFunction
  BronzeS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName: eon-bronze-bucket
      NotificationConfiguration:
        QueueConfigurations:
        - Event: s3:ObjectCreated:*
          Queue:
            Fn::GetAtt:
            - RawBucketEventsQueue
            - Arn
  SilverS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName: eon-silver-bucket
  RawBucketEventsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: EonMessageQueue
  SQSQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            AWS: '*'
          Action: SQS:SendMessage
          Resource: '*'
          Condition:
            ArnLike:
              aws:SourceArn: arn:aws:s3:::!GetAtt BronzeS3Bucket.BucketName
      Queues:
      - Ref: RawBucketEventsQueue
Outputs:
  HelloWorldFunction:
    Description: Bronze Function ARN
    Value:
      Fn::GetAtt:
      - BronzeTransformationFunction
      - Arn
  HelloWorldFunctionIamRole:
    Description: Implicit IAM Role created for BronzeTransformationFunction function
    Value:
      Fn::GetAtt:
      - BronzeTransformationFunction
      - Arn
